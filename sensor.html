<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <!-- üì± PWA META TAGS -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4CAF50">
    <meta name="background-color" content="#4CAF50">
    <meta name="display" content="standalone">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Smart Tent">
    
    <title>üèïÔ∏è Smart Tent - Tableau de Bord</title>
    
    <!-- üéØ PWA ICONS & MANIFEST -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="stylesheet" href="main.css">
    
    <!-- ‚ö° PRELOAD CRITICAL RESOURCES -->
    <link rel="preload" href="api.js" as="script">
</head>
<body>
    <!-- Votre contenu HTML reste identique -->
    
    <!-- üîß SCRIPTS CORRIG√âS -->
    <script>
        // üì± SMART TENT MOBILE APP - VERSION CORRIG√âE
        class SmartTentMobileApp {
            constructor() {
                this.updateInterval = null;
                this.currentTent = 'tent_001';
                this.isOnline = navigator.onLine;
                this.dataUsage = 0;
                
                // ‚úÖ ATTENDRE QUE L'API SOIT CHARG√âE
                this.initWhenReady();
            }

            async initWhenReady() {
                // Attendre que l'API soit disponible
                let attempts = 0;
                while (!window.smartTentAPI && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (window.smartTentAPI) {
                    this.api = window.smartTentAPI;
                    console.log('üì± API trouv√©e, initialisation...');
                    await this.init();
                } else {
                    console.error('‚ùå API non trouv√©e apr√®s 5 secondes');
                    this.showOfflineData();
                }
            }

            async init() {
                console.log('üì± Initializing Smart Tent Mobile App...');
                
                try {
                    // Setup core functionality
                    this.setupTentSelector();
                    this.setupConnectionMonitoring();
                    this.setupDataUsageTracking();
                    this.setupCriticalAlerts();
                    
                    // Load initial data
                    await this.loadData();
                    
                    // Start auto-update
                    this.startAutoUpdate();
                    
                    console.log('‚úÖ Mobile app initialized');
                } catch (error) {
                    console.error('‚ùå Erreur d\'initialisation:', error);
                    this.showOfflineData();
                }
            }

            setupTentSelector() {
                const selector = document.getElementById('tentSelector');
                if (!selector) {
                    console.warn('‚ö†Ô∏è Tent selector not found');
                    return;
                }
                
                // Charger les appareils depuis localStorage
                const savedDevices = localStorage.getItem('smartTentDevices');
                
                if (savedDevices) {
                    const devices = JSON.parse(savedDevices);
                    
                    if (devices.length === 0) {
                        selector.innerHTML = '<option value="">Aucune tente configur√©e</option>';
                        this.showNotification('Aucune tente configur√©e. Redirection...', 'warning');
                        setTimeout(() => window.location.href = 'index.html', 3000);
                        return;
                    }
                    
                    // Remplir le dropdown
                    selector.innerHTML = devices.map(device => 
                        `<option value="${device.id}">üèïÔ∏è ${device.name}</option>`
                    ).join('');
                    
                    // S√©lectionner le premier appareil
                    this.currentTent = devices[0].id;
                    selector.value = this.currentTent;
                    
                } else {
                    selector.innerHTML = '<option value="">Configurez vos appareils</option>';
                    this.showNotification('Veuillez configurer vos appareils', 'warning');
                    setTimeout(() => window.location.href = 'index.html', 3000);
                    return;
                }
                
                // Event listener pour changement
                selector.addEventListener('change', async (e) => {
                    await this.switchTent(e.target.value);
                });
            }

            async switchTent(tentId) {
                console.log(`üîÑ Switching to tent: ${tentId}`);
                this.currentTent = tentId;
                localStorage.setItem('selectedTent', tentId);
                this.showLoading();
                await this.loadData();
                this.showNotification(`Bascul√© vers ${tentId}`, 'success');
            }

            setupConnectionMonitoring() {
                const updateConnectionStatus = () => {
                    const status = document.getElementById('connectionStatus');
                    if (!status) return;
                    
                    if (navigator.onLine) {
                        status.className = 'status-indicator online';
                        status.innerHTML = '<div class="status-dot"></div>En ligne';
                        this.isOnline = true;
                    } else {
                        status.className = 'status-indicator offline';
                        status.innerHTML = '<div class="status-dot"></div>Hors ligne';
                        this.isOnline = false;
                    }
                };

                window.addEventListener('online', updateConnectionStatus);
                window.addEventListener('offline', updateConnectionStatus);
                updateConnectionStatus(); // Initial call
            }

            setupDataUsageTracking() {
                const updateDataUsage = () => {
                    this.dataUsage += 0.1;
                    const dataElement = document.getElementById('dataUsage');
                    if (dataElement) {
                        dataElement.textContent = `üìä ${this.dataUsage.toFixed(1)} MB`;
                    }
                };

                setInterval(updateDataUsage, 30000);
            }

            setupCriticalAlerts() {
                setInterval(() => {
                    this.checkCriticalConditions();
                }, 5000);
            }

            checkCriticalConditions() {
                const gasElement = document.getElementById('gasSensor');
                const batteryElement = document.getElementById('battery');
                
                if (!gasElement || !batteryElement) return;
                
                const gasValue = parseInt(gasElement.textContent) || 0;
                const batteryValue = parseInt(batteryElement.textContent) || 0;
                
                // Gas alert
                if (gasValue >= 300) {
                    this.showCriticalAlert(
                        '‚ö†Ô∏è ALERTE GAZ!',
                        `Niveau d√©tect√©: ${gasValue} ppm - Ventilez imm√©diatement`
                    );
                }
                
                // Battery alert
                if (batteryValue <= 10) {
                    this.showCriticalAlert(
                        'üîã BATTERIE FAIBLE!',
                        `Niveau batterie: ${batteryValue}% - Rechargez imm√©diatement`
                    );
                }
            }

            showCriticalAlert(title, message) {
                const alertsDiv = document.getElementById('criticalAlerts');
                if (alertsDiv) {
                    const content = alertsDiv.querySelector('.alert-content div');
                    if (content) {
                        content.innerHTML = `<strong>${title}</strong><br>${message}`;
                    }
                    alertsDiv.classList.add('visible');
                    
                    // Vibrate if supported
                    if ('vibrate' in navigator) {
                        navigator.vibrate([300, 100, 300, 100, 300]);
                    }
                }
            }

            async loadData() {
                try {
                    this.updateConnectionStatus(true);
                    
                    if (!this.api) {
                        throw new Error('API not available');
                    }
                    
                    console.log('üîÑ Loading data for tent:', this.currentTent);
                    const data = await this.api.getAllSensorData();
                    
                    if (data) {
                        this.updateSensorDisplays(data);
                        this.updateLastSync();
                        
                        // Cache les donn√©es
                        localStorage.setItem(`sensor-data-${this.currentTent}`, JSON.stringify(data));
                    } else {
                        this.showOfflineData();
                    }
                    
                } catch (error) {
                    console.error('‚ùå Failed to load data:', error);
                    this.updateConnectionStatus(false);
                    this.showOfflineData();
                }
            }

            updateSensorDisplays(data) {
                // Helper function to safely update element
                const updateElement = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    }
                };

                // Interior conditions
                updateElement('tempInterior', data.interior?.temperature ? `${data.interior.temperature}¬∞C` : '--¬∞C');
                updateElement('humidityInterior', data.interior?.humidity ? `${data.interior.humidity}%` : '--%');
                updateElement('gasSensor', data.interior?.gasLevel ? `${data.interior.gasLevel} ppm` : '-- ppm');
                updateElement('motionInterior', data.interior?.motion ? 'D√©tect√©' : 'Aucun');
                
                // Exterior conditions
                updateElement('tempExterior', data.exterior?.temperature ? `${data.exterior.temperature}¬∞C` : '--¬∞C');
                updateElement('humidityExterior', data.exterior?.humidity ? `${data.exterior.humidity}%` : '--%');
                updateElement('windSpeed', data.exterior?.windSpeed ? `${data.exterior.windSpeed} km/h` : '-- km/h');
                updateElement('motionExterior', data.exterior?.motion ? 'D√©tect√©' : 'Aucun');
                
                // System status
                updateElement('signal4g', data.system?.signal4G ? `${data.system.signal4G}%` : '-- %');
                updateElement('battery', data.system?.batteryLevel ? `${data.system.batteryLevel}%` : '-- %');
                updateElement('cpuTemp', data.system?.deviceTemperature ? `${data.system.deviceTemperature}¬∞C` : '--¬∞C');
                
                // Update visual indicators
                this.updateVisualIndicators(data);
                
                console.log('‚úÖ Sensor displays updated');
            }

            updateVisualIndicators(data) {
                // Gas sensor bar
                const gasValue = data.interior?.gasLevel || 0;
                const gasBar = document.getElementById('gasSensorBar');
                if (gasBar) {
                    const gasPercentage = Math.min((gasValue / 1000) * 100, 100);
                    gasBar.style.width = `${gasPercentage}%`;
                    
                    if (gasValue < 200) {
                        gasBar.className = 'battery-fill';
                    } else if (gasValue < 300) {
                        gasBar.className = 'battery-fill low';
                    } else {
                        gasBar.className = 'battery-fill critical';
                    }
                }
                
                // Battery indicator
                const batteryValue = data.system?.batteryLevel || 0;
                const batteryBar = document.getElementById('battery-indicator');
                if (batteryBar) {
                    batteryBar.style.width = `${batteryValue}%`;
                    
                    if (batteryValue > 30) {
                        batteryBar.className = 'battery-fill';
                    } else if (batteryValue > 10) {
                        batteryBar.className = 'battery-fill low';
                    } else {
                        batteryBar.className = 'battery-fill critical';
                    }
                }
                
                // Signal bars
                const signalValue = data.system?.signal4G || 0;
                const signalBars = document.querySelectorAll('#signal-bars .bar');
                const activeBars = Math.ceil((signalValue / 100) * 4);
                
                signalBars.forEach((bar, index) => {
                    if (index < activeBars) {
                        bar.classList.add('active');
                    } else {
                        bar.classList.remove('active');
                    }
                });
            }

            showOfflineData() {
                const cachedData = localStorage.getItem(`sensor-data-${this.currentTent}`);
                if (cachedData) {
                    try {
                        const data = JSON.parse(cachedData);
                        this.updateSensorDisplays(data);
                        this.showNotification('Utilisation des donn√©es en cache', 'warning');
                    } catch (error) {
                        console.error('‚ùå Error parsing cached data:', error);
                        this.setDefaultValues();
                    }
                } else {
                    this.setDefaultValues();
                }
            }

            setDefaultValues() {
                const elements = [
                    'tempInterior', 'humidityInterior', 'gasSensor', 'motionInterior',
                    'tempExterior', 'humidityExterior', 'windSpeed', 'motionExterior',
                    'signal4g', 'battery', 'cpuTemp'
                ];
                
                elements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = '--';
                    }
                });
            }

            updateConnectionStatus(online) {
                const status = document.getElementById('connectionStatus');
                if (status) {
                    if (online) {
                        status.className = 'status-indicator online';
                        status.innerHTML = '<div class="status-dot"></div>En ligne';
                    } else {
                        status.className = 'status-indicator offline';
                        status.innerHTML = '<div class="status-dot"></div>Hors ligne';
                    }
                }
            }

            updateLastSync() {
                const now = new Date();
                const time = now.toLocaleTimeString('fr-FR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const cameraInfo = document.getElementById('cameraInfo');
                if (cameraInfo) {
                    cameraInfo.textContent = `Derni√®re mise √† jour: ${time}`;
                }
            }

            startAutoUpdate() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                }
                
                this.updateInterval = setInterval(() => {
                    if (this.isOnline && this.api) {
                        this.loadData();
                    }
                }, 2000);
                
                console.log('üîÑ Auto-update started');
            }

            showLoading() {
                const sensors = document.querySelectorAll('.sensor-value');
                sensors.forEach(sensor => {
                    sensor.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
                });
            }

            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }

        // Global functions
        let mobileApp;

        function dismissCriticalAlert() {
            const alertsDiv = document.getElementById('criticalAlerts');
            if (alertsDiv) {
                alertsDiv.classList.remove('visible');
            }
        }

        // Wait for DOM and API to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        function initializeApp() {
            // Wait a bit for api.js to load
            setTimeout(() => {
                mobileApp = new SmartTentMobileApp();
                window.mobileApp = mobileApp; // Make it globally available
            }, 500);
        }
    </script>

    <!-- üîß API SCRIPT - CHARG√â EN DERNIER -->
    <script src="api.js"></script>
</body>
</html>
