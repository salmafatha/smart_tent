<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <!-- üì± PWA META TAGS -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4CAF50">
    <meta name="background-color" content="#4CAF50">
    <meta name="display" content="standalone">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Smart Tent">
    
    <title>üèïÔ∏è Smart Tent - Tableau de Bord</title>
    
    <!-- üéØ PWA ICONS & MANIFEST -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="stylesheet" href="main.css">

    
    <!-- ‚ö° PRELOAD CRITICAL RESOURCES -->
    <link rel="preload" href="api.js" as="script">
    
    <style>
        /* üé® SMART TENT COMPLETE MOBILE THEME */
        :root {
            --primary-green: #4CAF50;
            --dark-green: #2E7D32;
            --light-green: #81C784;
            --bg-green: #F1F8E9;
            --warning-orange: #FF9800;
            --danger-red: #F44336;
            --info-blue: #2196F3;
            --text-dark: #2C3E50;
            --text-light: #7F8C8D;
            --card-shadow: 0 4px 12px rgba(46, 125, 50, 0.15);
            --border-radius: 12px;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-green) 0%, #E8F5E8 100%);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
            touch-action: manipulation;
            -webkit-overflow-scrolling: touch;
        }

        /* üì± MOBILE OPTIMIZATION */
        .app-container {
            max-width: 100vw;
            overflow-x: hidden;
        }

        /* üè† ENHANCED HEADER */
        .header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--dark-green) 100%);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: var(--safe-area-top);
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .tent-icon {
            font-size: 1.5rem;
            animation: tentGlow 3s infinite;
        }

        @keyframes tentGlow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }

        .tent-info h1 {
            font-size: 1.3rem;
            margin-bottom: 0.2rem;
        }

        .tent-selector {
            margin-top: 0.25rem;
        }

        .tent-dropdown {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            outline: none;
            transition: all 0.2s ease;
        }

        .tent-dropdown:hover {
            background: rgba(255,255,255,0.25);
        }

        .tent-dropdown option {
            background: var(--dark-green);
            color: white;
        }

        .status-indicators {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .status-indicator {
            background: rgba(255,255,255,0.2);
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator.online {
            background: rgba(76, 175, 80, 0.3);
        }

        .status-indicator.offline {
            background: rgba(244, 67, 54, 0.3);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        /* üìä MAIN NAVIGATION */
        .main-nav {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 0.5rem 1rem;
            position: sticky;
            top: calc(80px + var(--safe-area-top));
            z-index: 90;
        }

        .nav-buttons {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .nav-buttons::-webkit-scrollbar {
            display: none;
        }

        .nav-btn {
            background: var(--bg-green);
            border: none;
            padding: 0.8rem 1.2rem;
            border-radius: 25px;
            font-weight: 600;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: fit-content;
        }

        .nav-btn.active {
            background: var(--primary-green);
            color: white;
        }

        .nav-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* üö® CRITICAL ALERTS BAR */
        .critical-alerts {
            background: linear-gradient(90deg, var(--danger-red), #FF6B6B);
            color: white;
            padding: 1rem;
            margin: 1rem;
            border-radius: var(--border-radius);
            display: none;
            animation: alertPulse 1s infinite;
        }

        .critical-alerts.visible {
            display: block;
        }

        @keyframes alertPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .alert-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-dismiss {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
        }

        /* üì± MOBILE DASHBOARD LAYOUT */
        .mobile-dashboard {
            padding: 1rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .dashboard-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease;
        }

        .dashboard-section:active {
            transform: scale(0.98);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 1.5rem;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .section-icon {
            font-size: 1.2rem;
        }

        /* üìä SENSOR GRID */
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
        }

        .sensor-card {
            background: var(--bg-green);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .sensor-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .sensor-icon {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .sensor-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary-green);
            margin-bottom: 0.25rem;
        }

        .sensor-label {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        /* üîã BATTERY INDICATOR */
        .battery-indicator {
            width: 100%;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .battery-fill {
            height: 100%;
            background: var(--primary-green);
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .battery-fill.low {
            background: var(--warning-orange);
        }

        .battery-fill.critical {
            background: var(--danger-red);
            animation: batteryAlert 1s infinite;
        }

        @keyframes batteryAlert {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* üì° SIGNAL BARS */
        .signal-bars {
            display: flex;
            gap: 2px;
            justify-content: center;
            margin-top: 0.5rem;
        }

        .bar {
            width: 6px;
            height: 12px;
            background: #ddd;
            border-radius: 1px;
        }

        .bar.active {
            background: var(--primary-green);
        }

        /* üìπ ENHANCED CAMERA SECTION */
        .camera-section-large {
            grid-column: 1;
        }

        .camera-container-large {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .camera-frame-large {
            position: relative;
            background: #000;
            border-radius: var(--border-radius);
            overflow: hidden;
            aspect-ratio: 16/9;
            width: 100%;
        }

        .camera-frame-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                to bottom,
                rgba(0,0,0,0.6) 0%,
                transparent 30%,
                transparent 70%,
                rgba(0,0,0,0.6) 100%
            );
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1rem;
        }

        .camera-status {
            align-self: flex-start;
            background: var(--danger-red);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        .camera-info {
            align-self: flex-end;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .camera-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.8rem;
        }

        /* üéÆ ACTION BUTTONS */
        .action-btn {
            background: var(--primary-green);
            color: white;
            border: none;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .action-btn:hover {
            background: var(--dark-green);
            transform: translateY(-1px);
        }

        .action-btn.secondary {
            background: var(--text-light);
        }

        .action-btn.secondary:hover {
            background: #6C7B7D;
        }

        .action-btn.danger {
            background: var(--danger-red);
        }

        .action-btn.recording {
            background: var(--danger-red);
            animation: recordingPulse 1s infinite;
        }

        @keyframes recordingPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* üîô BACK BUTTON */
        .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s ease;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* üîî LOADING STATES */
        .loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--text-light);
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--bg-green);
            border-top: 2px solid var(--primary-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* üîî NOTIFICATION STYLES */
        .notification {
            position: fixed;
            bottom: calc(20px + var(--safe-area-bottom));
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-green);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideUp 0.5s ease;
            max-width: 90vw;
        }

        .notification.error {
            background: var(--danger-red);
        }

        .notification.warning {
            background: var(--warning-orange);
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* üì± MOBILE RESPONSIVE */
        @media (max-width: 767px) {
            .mobile-dashboard {
                padding: 0.5rem;
                gap: 0.8rem;
            }
            
            .dashboard-section {
                padding: 1rem;
            }
            
            .sensor-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.8rem;
            }
            
            .camera-controls {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .action-btn {
                padding: 0.7rem 0.8rem;
                font-size: 0.8rem;
            }
            
            .nav-buttons {
                gap: 0.3rem;
            }
            
            .nav-btn {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
        }

        /* üåô DARK MODE */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-green: #1B2E20;
                --text-dark: #E8F5E8;
                --text-light: #A5D6A7;
            }
            
            body {
                background: linear-gradient(135deg, #0D1A0F 0%, #1B2E20 100%);
            }
            
            .dashboard-section {
                background: #2C5530;
                color: var(--text-dark);
            }
            
            .main-nav {
                background: #2C5530;
            }
            
            .sensor-card {
                background: #1B2E20;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- üè† ENHANCED HEADER -->
        <header class="header">
            <div class="header-content">
                <div class="header-title">
                    <a href="index.html" class="back-btn">
                        d√©connection
                    </a>
                    <div class="tent-icon">üèïÔ∏è</div>
                    <div class="tent-info">
                        <h1>Tableau de Bord</h1>
                        <div class="tent-selector">
                            <select id="tentSelector" class="tent-dropdown">
                                <!-- Les tentes seront charg√©es dynamiquement -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="status-indicators">
                    <div class="status-indicator online" id="connectionStatus">
                        <div class="status-dot"></div>
                        En ligne
                    </div>
                    <div class="status-indicator" id="dataUsage">
                        üìä 0 MB
                    </div>
                </div>
            </div>
        </header>

        <!-- üìä MAIN NAVIGATION -->
        <nav class="main-nav">
            <div class="nav-buttons">
                <a href="index.html" class="nav-btn active">
                    üè† Tableau de bord
                </a>
                <a href="history.html" class="nav-btn">
                    üìä Historique
                </a>
                <a href="map.html" class="nav-btn">
                    üó∫Ô∏è Carte
                </a>
                <a href="settings.html" class="nav-btn">
                    ‚öôÔ∏è Param√®tres
                </a>
            </div>
        </nav>

        <!-- üö® CRITICAL ALERTS -->
        <div class="critical-alerts" id="criticalAlerts">
            <div class="alert-content">
                <div>
                    <strong>‚ö†Ô∏è ALERTE GAZ!</strong><br>
                    Niveau d√©tect√©: 450 ppm - Ventilez imm√©diatement
                </div>
                <button class="alert-dismiss" onclick="dismissCriticalAlert()">√ó</button>
            </div>
        </div>

        <!-- üì± MAIN CONTENT -->
        <main class="mobile-dashboard" id="mainContent">
            
            <!-- üè† CONDITIONS INT√âRIEURES -->
            <div class="dashboard-section">
                <div class="section-header">
                    <div class="section-icon">üè†</div>
                    <div class="section-title">Conditions Int√©rieures</div>
                </div>
                
                <div class="sensor-grid">
                    <div class="sensor-card" onclick="showSensorDetails('temperature-interior')">
                        <div class="sensor-icon">üå°Ô∏è</div>
                        <div class="sensor-value" id="tempInterior">--¬∞C</div>
                        <div class="sensor-label">Temp√©rature</div>
                    </div>
                    
                    <div class="sensor-card" onclick="showSensorDetails('humidity-interior')">
                        <div class="sensor-icon">üíß</div>
                        <div class="sensor-value" id="humidityInterior">--%</div>
                        <div class="sensor-label">Humidit√©</div>
                    </div>
                    
                    <div class="sensor-card" onclick="showSensorDetails('gas')">
                        <div class="sensor-icon">üí®</div>
                        <div class="sensor-value" id="gasSensor">-- ppm</div>
                        <div class="sensor-label">Gaz (MQ2)</div>
                        <div class="battery-indicator">
                            <div class="battery-fill" id="gasSensorBar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="sensor-card" onclick="showSensorDetails('motion-interior')">
                        <div class="sensor-icon">üëÅÔ∏è</div>
                        <div class="sensor-value" id="motionInterior">Aucun</div>
                        <div class="sensor-label">Mouvement</div>
                    </div>
                </div>
                
                <div style="margin-top: 1rem; display: flex; gap: 0.8rem;">
                    <button class="action-btn" onclick="activateComfortMode()">
                        üå°Ô∏è Mode Confort
                    </button>
                    <button class="action-btn secondary" onclick="refreshInteriorData()">
                        üîÑ Actualiser
                    </button>
                </div>
            </div>

            <!-- üåç CONDITIONS EXT√âRIEURES -->
            <div class="dashboard-section">
                <div class="section-header">
                    <div class="section-icon">üåç</div>
                    <div class="section-title">Conditions Ext√©rieures</div>
                </div>
                
                <div class="sensor-grid">
                    <div class="sensor-card" onclick="showSensorDetails('temperature-exterior')">
                        <div class="sensor-icon">üå°Ô∏è</div>
                        <div class="sensor-value" id="tempExterior">--¬∞C</div>
                        <div class="sensor-label">Temp√©rature</div>
                    </div>
                    
                    <div class="sensor-card" onclick="showSensorDetails('humidity-exterior')">
                        <div class="sensor-icon">üíß</div>
                        <div class="sensor-value" id="humidityExterior">--%</div>
                        <div class="sensor-label">Humidit√©</div>
                    </div>
                    
                    <div class="sensor-card" onclick="showSensorDetails('wind')">
                        <div class="sensor-icon">üå¨Ô∏è</div>
                        <div class="sensor-value" id="windSpeed">-- km/h</div>
                        <div class="sensor-label">Vent</div>
                    </div>
                    
                    <div class="sensor-card" onclick="showSensorDetails('motion-exterior')">
                        <div class="sensor-icon">üö∂</div>
                        <div class="sensor-value" id="motionExterior">Aucun</div>
                        <div class="sensor-label">Mouvement</div>
                    </div>
                </div>
                
                <div style="margin-top: 1rem; display: flex; gap: 0.8rem;">
                    <button class="action-btn" onclick="getWeatherForecast()">
                        üå§Ô∏è M√©t√©o
                    </button>
                    <button class="action-btn secondary" onclick="refreshExteriorData()">
                        üîÑ Actualiser
                    </button>
                </div>
            </div>

            <!-- üîß SYST√àME -->
            <div class="dashboard-section">
                <div class="section-header">
                    <div class="section-icon">üîß</div>
                    <div class="section-title">Syst√®me</div>
                </div>
                
                <div class="sensor-grid">
                    <div class="sensor-card" onclick="showSensorDetails('signal')">
                        <div class="sensor-icon">üì°</div>
                        <div class="sensor-value" id="signal4g">-- %</div>
                        <div class="sensor-label">Signal 4G</div>
                        <div class="signal-bars" id="signal-bars">
                            <div class="bar"></div>
                            <div class="bar"></div>
                            <div class="bar"></div>
                            <div class="bar"></div>
                        </div>
                    </div>
                    
                    <div class="sensor-card" onclick="showSensorDetails('battery')">
                        <div class="sensor-icon">üîã</div>
                        <div class="sensor-value" id="battery">-- %</div>
                        <div class="sensor-label">Batterie</div>
                        <div class="battery-indicator">
                            <div class="battery-fill" id="battery-indicator" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="sensor-card" onclick="showSensorDetails('cpu')">
                        <div class="sensor-icon">üíª</div>
                        <div class="sensor-value" id="cpuTemp">--¬∞C</div>
                        <div class="sensor-label">CPU Temp</div>
                    </div>
                    
                    <div class="sensor-card" onclick="showSensorDetails('storage')">
                        <div class="sensor-icon">üíæ</div>
                        <div class="sensor-value" id="storage">-- GB</div>
                        <div class="sensor-label">Stockage</div>
                    </div>
                </div>
                
                <div style="margin-top: 1rem; display: flex; gap: 0.8rem;">
                    <button class="action-btn" onclick="runDiagnostic()">
                        üîç Diagnostic
                    </button>
                    <button class="action-btn secondary" onclick="optimizeSystem()">
                        ‚ö° Optimiser
                    </button>
                </div>
            </div>

            <!-- üìπ SURVEILLANCE (ENHANCED) -->
            <div class="dashboard-section camera-section-large">
                <div class="section-header">
                    <div class="section-icon">üìπ</div>
                    <div class="section-title">Surveillance</div>
                </div>
                
                <div class="camera-container-large">
                    <div class="camera-frame-large">
                        <img id="cameraFeed" 
                             src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300'%3E%3Crect width='400' height='300' fill='%23000'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='0.3em' font-family='Arial' font-size='18' fill='%23fff'%3EFlux de la cam√©ra%3C/text%3E%3C/svg%3E" 
                             alt="Camera feed">
                        <div class="camera-overlay">
                            <div class="camera-status" id="cameraStatus">
                                üî¥ EN DIRECT
                            </div>
                            <div class="camera-info" id="cameraInfo">
                                Derni√®re mise √† jour: --:--
                            </div>
                        </div>
                    </div>
                    
                    <div class="camera-controls">
                        <button class="action-btn" onclick="takePhoto()">
                            üì∏ Photo
                        </button>
                        <button class="action-btn secondary" onclick="toggleDetection()" id="detectionBtn">
                            üëÅÔ∏è D√©tection
                        </button>
                        <button class="action-btn secondary" onclick="toggleRecording()" id="recordBtn">
                            üé• Enregistrer
                        </button>
                        <button class="action-btn secondary" onclick="toggleFullscreen()">
                            üîç Plein √©cran
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Include API -->
    <script src="api.js"></script>
    
    <script>
        // üì± SMART TENT COMPLETE MOBILE APP WITH MONGODB INTEGRATION
        class SmartTentMobileApp {
            constructor() {
                this.api = window.smartTentAPI;
                this.updateInterval = null;
                this.currentTent = null;
                this.isOnline = navigator.onLine;
                this.dataUsage = 0;
                
                this.init();
            }

            async init() {
                console.log('üì± Initializing Smart Tent Mobile App with MongoDB...');
                
                // Setup core functionality
                await this.setupTentSelector();
                this.setupConnectionMonitoring();
                this.setupDataUsageTracking();
                this.setupCriticalAlerts();
                
                // Load initial data if device is selected
                if (this.currentTent) {
                    await this.loadData();
                    this.startAutoUpdate();
                }
                
                console.log('‚úÖ Mobile app initialized');
            }

            async setupTentSelector() {
                const selector = document.getElementById('tentSelector');
                
                try {
                    // First, load devices from MongoDB backend
                    const devices = await this.api.getDevices();
                    
                    if (devices.length === 0) {
                        // No devices found in database
                        selector.innerHTML = '<option value="">Aucune tente trouv√©e</option>';
                        setTimeout(() => {
                            alert('Aucune tente trouv√©e dans la base de donn√©es. Veuillez v√©rifier votre backend.');
                            window.location.href = 'index.html';
                        }, 2000);
                        return;
                    }
                    
                    // Populate dropdown with devices from MongoDB
                    selector.innerHTML = devices.map(device => 
                        `<option value="${device.id}">üèïÔ∏è ${device.name}</option>`
                    ).join('');
                    
                    // Set current device
                    const savedTent = localStorage.getItem('selectedTent');
                    if (savedTent && devices.some(device => device.id === savedTent)) {
                        this.currentTent = savedTent;
                        selector.value = savedTent;
                        this.api.setCurrentDevice(savedTent);
                    } else if (devices.length > 0) {
                        // Select first device if no saved device
                        this.currentTent = devices[0].id;
                        selector.value = this.currentTent;
                        this.api.setCurrentDevice(this.currentTent);
                        localStorage.setItem('selectedTent', this.currentTent);
                    }
                    
                } catch (error) {
                    console.error('Failed to load devices from MongoDB:', error);
                    
                    // Fallback to localStorage devices (from index.html)
                    const savedDevices = localStorage.getItem('smartTentDevices');
                    if (savedDevices) {
                        const devices = JSON.parse(savedDevices);
                        
                        if (devices.length === 0) {
                            selector.innerHTML = '<option value="">Aucune tente configur√©e</option>';
                            setTimeout(() => {
                                alert('Aucune tente configur√©e. Redirection vers la page de configuration...');
                                window.location.href = 'index.html';
                            }, 2000);
                            return;
                        }
                        
                        selector.innerHTML = devices.map(device => 
                            `<option value="${device.id}">üèïÔ∏è ${device.name}</option>`
                        ).join('');
                        
                        this.currentTent = devices[0].id;
                        selector.value = this.currentTent;
                        this.api.setCurrentDevice(this.currentTent);
                    } else {
                        selector.innerHTML = '<option value="">Erreur de connexion</option>';
                        setTimeout(() => {
                            alert('Impossible de charger les appareils. V√©rifiez votre connexion au backend.');
                            window.location.href = 'index.html';
                        }, 2000);
                        return;
                    }
                }
                
                selector.addEventListener('change', async (e) => {
                    await this.switchTent(e.target.value);
                });
            }

            async switchTent(tentId) {
                console.log(`üîÑ Switching to tent: ${tentId}`);
                
                this.currentTent = tentId;
                this.api.setCurrentDevice(tentId);
                localStorage.setItem('selectedTent', tentId);
                
                // Show loading state
                this.showLoading();
                
                // Stop current updates
                this.stopAutoUpdate();
                
                // Load data for new tent
                await this.loadData();
                
                // Restart auto-update
                this.startAutoUpdate();
                
                this.showNotification(`Bascul√© vers ${tentId}`, 'success');
            }

            setupConnectionMonitoring() {
                const updateConnectionStatus = () => {
                    const status = document.getElementById('connectionStatus');
                    
                    if (navigator.onLine && this.api.isOnline) {
                        status.className = 'status-indicator online';
                        status.innerHTML = '<div class="status-dot"></div>En ligne';
                        this.isOnline = true;
                    } else {
                        status.className = 'status-indicator offline';
                        status.innerHTML = '<div class="status-dot"></div>Hors ligne';
                        this.isOnline = false;
                    }
                };

                window.addEventListener('online', updateConnectionStatus);
                window.addEventListener('offline', updateConnectionStatus);
                
                // Listen to API connection events
                this.api.addEventListener('connection', (data) => {
                    this.isOnline = data.online;
                    updateConnectionStatus();
                });
            }

            setupDataUsageTracking() {
                // Simulated data usage tracking
                const updateDataUsage = () => {
                    this.dataUsage += 0.1; // 0.1 MB per update
                    const dataElement = document.getElementById('dataUsage');
                    dataElement.textContent = `üìä ${this.dataUsage.toFixed(1)} MB`;
                };

                setInterval(updateDataUsage, 30000); // Update every 30 seconds
            }

            setupCriticalAlerts() {
                // Check for critical alerts periodically
                setInterval(async () => {
                    await this.checkCriticalConditions();
                }, 5000);
            }

            async checkCriticalConditions() {
                try {
                    // Get recent alerts from MongoDB
                    const alerts = await this.api.getAlerts(1); // Last 1 hour
                    
                    // Check for critical unacknowledged alerts
                    const criticalAlerts = alerts.filter(alert => 
                        alert.severity === 'critical' && !alert.acknowledged
                    );
                    
                    if (criticalAlerts.length > 0) {
                        const latestAlert = criticalAlerts[0];
                        this.showCriticalAlert(
                            `‚ö†Ô∏è ${latestAlert.type.toUpperCase()}!`,
                            latestAlert.message
                        );
                    }
                    
                    // Also check current sensor values
                    const gasValue = parseInt(document.getElementById('gasSensor').textContent);
                    const batteryValue = parseInt(document.getElementById('battery').textContent);
                    
                    // Gas alert
                    if (gasValue >= 300 && !isNaN(gasValue)) {
                        this.showCriticalAlert(
                            '‚ö†Ô∏è ALERTE GAZ!',
                            `Niveau d√©tect√©: ${gasValue} ppm - Ventilez imm√©diatement`
                        );
                    }
                    
                    // Battery alert
                    if (batteryValue <= 10 && !isNaN(batteryValue)) {
                        this.showCriticalAlert(
                            'üîã BATTERIE FAIBLE!',
                            `Niveau batterie: ${batteryValue}% - Rechargez imm√©diatement`
                        );
                    }
                } catch (error) {
                    console.error('Error checking critical conditions:', error);
                }
            }

            showCriticalAlert(title, message) {
                const alertsDiv = document.getElementById('criticalAlerts');
                alertsDiv.querySelector('.alert-content div').innerHTML = `<strong>${title}</strong><br>${message}`;
                alertsDiv.classList.add('visible');
                
                // Vibrate if supported
                if ('vibrate' in navigator) {
                    navigator.vibrate([300, 100, 300, 100, 300]);
                }
            }

            async loadData() {
                if (!this.currentTent) {
                    console.warn('No tent selected for data loading');
                    return;
                }

                try {
                    this.updateConnectionStatus(true);
                    
                    // Get real-time sensor data from MongoDB
                    const data = await this.api.getAllSensorData();
                    
                    if (data && data.deviceId) {
                        this.updateSensorDisplays(data);
                        this.updateLastSync();
                        
                        // Cache the data for offline use
                        localStorage.setItem(`sensor-data-${this.currentTent}`, JSON.stringify(data));
                    } else {
                        this.showOfflineData();
                    }
                    
                } catch (error) {
                    console.error('‚ùå Failed to load data from MongoDB:', error);
                    this.updateConnectionStatus(false);
                    this.showOfflineData();
                }
            }

            updateSensorDisplays(data) {
                // Interior conditions
                document.getElementById('tempInterior').textContent = `${data.interior.temperature}¬∞C`;
                document.getElementById('humidityInterior').textContent = `${data.interior.humidity}%`;
                document.getElementById('gasSensor').textContent = `${data.interior.gasLevel} ppm`;
                document.getElementById('motionInterior').textContent = data.interior.motion ? 'D√©tect√©' : 'Aucun';
                
                // Exterior conditions
                document.getElementById('tempExterior').textContent = `${data.exterior.temperature}¬∞C`;
                document.getElementById('humidityExterior').textContent = `${data.exterior.humidity}%`;
                document.getElementById('windSpeed').textContent = `${data.exterior.windSpeed} km/h`;
                document.getElementById('motionExterior').textContent = data.exterior.motion ? 'D√©tect√©' : 'Aucun';
                
                // System status
                document.getElementById('signal4g').textContent = `${data.system.signal4G}%`;
                document.getElementById('battery').textContent = `${data.system.batteryLevel}%`;
                document.getElementById('cpuTemp').textContent = `${data.system.deviceTemperature}¬∞C`;
                document.getElementById('storage').textContent = `${data.system.storage} GB`;
                
                // Update visual indicators
                this.updateVisualIndicators(data);
                
                // Update camera feed if available
                if (data.camera.hasImage && data.camera.imageData) {
                    document.getElementById('cameraFeed').src = data.camera.imageData;
                }
            }

            updateVisualIndicators(data) {
                // Gas sensor bar
                const gasValue = data.interior.gasLevel;
                const gasBar = document.getElementById('gasSensorBar');
                const gasPercentage = Math.min((gasValue / 1000) * 100, 100);
                gasBar.style.width = `${gasPercentage}%`;
                
                if (gasValue < 200) {
                    gasBar.className = 'battery-fill';
                } else if (gasValue < 300) {
                    gasBar.className = 'battery-fill low';
                } else {
                    gasBar.className = 'battery-fill critical';
                }
                
                // Battery indicator
                const batteryValue = data.system.batteryLevel;
                const batteryBar = document.getElementById('battery-indicator');
                batteryBar.style.width = `${batteryValue}%`;
                
                if (batteryValue > 30) {
                    batteryBar.className = 'battery-fill';
                } else if (batteryValue > 10) {
                    batteryBar.className = 'battery-fill low';
                } else {
                    batteryBar.className = 'battery-fill critical';
                }
                
                // Signal bars
                const signalValue = data.system.signal4G;
                const signalBars = document.querySelectorAll('#signal-bars .bar');
                const activeBars = Math.ceil((signalValue / 100) * 4);
                
                signalBars.forEach((bar, index) => {
                    if (index < activeBars) {
                        bar.classList.add('active');
                    } else {
                        bar.classList.remove('active');
                    }
                });
            }

            showOfflineData() {
                // Load cached data from localStorage
                const cachedData = localStorage.getItem(`sensor-data-${this.currentTent}`);
                if (cachedData) {
                    const data = JSON.parse(cachedData);
                    this.updateSensorDisplays(data);
                    this.showNotification('Utilisation des donn√©es en cache', 'warning');
                } else {
                    // Show empty state
                    document.querySelectorAll('.sensor-value').forEach(el => {
                        if (!el.textContent.includes('--')) {
                            el.textContent = '--';
                        }
                    });
                }
            }

            updateConnectionStatus(online) {
                const status = document.getElementById('connectionStatus');
                if (online) {
                    status.className = 'status-indicator online';
                    status.innerHTML = '<div class="status-dot"></div>En ligne';
                } else {
                    status.className = 'status-indicator offline';
                    status.innerHTML = '<div class="status-dot"></div>Hors ligne';
                }
            }

            updateLastSync() {
                const now = new Date();
                const time = now.toLocaleTimeString('fr-FR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                document.getElementById('cameraInfo').textContent = `Derni√®re mise √† jour: ${time}`;
            }

            startAutoUpdate() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                }
                
                this.updateInterval = setInterval(async () => {
                    if (this.isOnline && this.currentTent) {
                        await this.loadData();
                    }
                }, 2000); // Update every 2 seconds when online
                
                console.log('üîÑ Auto-update started for MongoDB integration');
            }

            stopAutoUpdate() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                    this.updateInterval = null;
                    console.log('‚èπÔ∏è Auto-update stopped');
                }
            }

            showLoading() {
                // Show loading spinners on sensor cards
                const sensors = document.querySelectorAll('.sensor-value');
                sensors.forEach(sensor => {
                    sensor.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
                });
            }

            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }

        // üéÆ GLOBAL FUNCTIONS FOR MONGODB INTEGRATION
        let mobileApp;

        function dismissCriticalAlert() {
            document.getElementById('criticalAlerts').classList.remove('visible');
        }

        function showSensorDetails(sensorType) {
            // Show detailed sensor information
            console.log(`üìä Showing details for: ${sensorType}`);
            mobileApp.showNotification(`D√©tails pour ${sensorType}`, 'info');
        }

        async function takePhoto() {
            console.log('üì∏ Taking photo...');
            try {
                if (!mobileApp.currentTent) {
                    throw new Error('No device selected');
                }
                
                await mobileApp.api.sendCommand('take_photo', {
                    resolution: 'high',
                    timestamp: new Date().toISOString()
                });
                
                mobileApp.showNotification('Photo prise avec succ√®s!', 'success');
                
                // Refresh data to get new photo
                setTimeout(() => mobileApp.loadData(), 1000);
                
            } catch (error) {
                console.error('Failed to take photo:', error);
                mobileApp.showNotification('Erreur lors de la prise de photo', 'error');
            }
        }

        async function toggleDetection() {
            console.log('üëÅÔ∏è Toggling detection...');
            const btn = document.getElementById('detectionBtn');
            const isActive = btn.textContent.includes('Arr√™ter');
            
            try {
                if (!mobileApp.currentTent) {
                    throw new Error('No device selected');
                }
                
                const command = isActive ? 'stop_motion_detection' : 'start_motion_detection';
                await mobileApp.api.sendCommand(command, {
                    sensitivity: 'medium',
                    zones: ['exterior']
                });
                
                btn.textContent = isActive ? 'üëÅÔ∏è D√©marrer' : 'üëÅÔ∏è Arr√™ter';
                mobileApp.showNotification(
                    isActive ? 'D√©tection arr√™t√©e' : 'D√©tection d√©marr√©e', 
                    'success'
                );
            } catch (error) {
                console.error('Failed to toggle detection:', error);
                mobileApp.showNotification('Erreur lors de la modification de la d√©tection', 'error');
            }
        }

        async function toggleRecording() {
            console.log('üé• Toggling recording...');
            const btn = document.getElementById('recordBtn');
            const isRecording = btn.classList.contains('recording');
            
            try {
                if (!mobileApp.currentTent) {
                    throw new Error('No device selected');
                }
                
                const command = isRecording ? 'stop_recording' : 'start_recording';
                await mobileApp.api.sendCommand(command, {
                    duration: '300', // 5 minutes
                    quality: 'medium'
                });
                
                if (isRecording) {
                    btn.textContent = 'üé• Enregistrer';
                    btn.classList.remove('recording');
                } else {
                    btn.textContent = 'üé• Arr√™ter';
                    btn.classList.add('recording');
                }
                
                mobileApp.showNotification(
                    isRecording ? 'Enregistrement arr√™t√©' : 'Enregistrement d√©marr√©', 
                    'success'
                );
            } catch (error) {
                console.error('Failed to toggle recording:', error);
                mobileApp.showNotification('Erreur lors de l\'enregistrement', 'error');
            }
        }

        function toggleFullscreen() {
            const cameraFrame = document.querySelector('.camera-frame-large');
            
            if (!document.fullscreenElement) {
                cameraFrame.requestFullscreen().catch(err => {
                    console.error('Error enabling fullscreen:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        async function activateComfortMode() {
            console.log('üå°Ô∏è Activating comfort mode...');
            try {
                if (!mobileApp.currentTent) {
                    throw new Error('No device selected');
                }
                
                await mobileApp.api.sendCommand('comfort_mode', {
                    target_temperature: 22,
                    target_humidity: 50,
                    auto_adjust: true
                });
                
                mobileApp.showNotification('Mode confort activ√©!', 'success');
            } catch (error) {
                console.error('Failed to activate comfort mode:', error);
                mobileApp.showNotification('Erreur lors de l\'activation du mode confort', 'error');
            }
        }

        async function refreshInteriorData() {
            console.log('üè† Refreshing interior data...');
            mobileApp.showLoading();
            await mobileApp.loadData();
        }

        async function refreshExteriorData() {
            console.log('üåç Refreshing exterior data...');
            mobileApp.showLoading();
            await mobileApp.loadData();
        }

        async function getWeatherForecast() {
            console.log('üå§Ô∏è Getting weather forecast...');
            try {
                if (!mobileApp.currentTent) {
                    throw new Error('No device selected');
                }
                
                const weatherData = await mobileApp.api.getWeatherData();
                
                // Show weather info in a notification
                mobileApp.showNotification(
                    `M√©t√©o: ${weatherData.temperature}¬∞C, ${weatherData.description}`, 
                    'success'
                );
            } catch (error) {
                console.error('Failed to get weather:', error);
                mobileApp.showNotification('Erreur lors de la r√©cup√©ration de la m√©t√©o', 'error');
            }
        }

        async function runDiagnostic() {
            console.log('üîß Running system diagnostic...');
            try {
                if (!mobileApp.currentTent) {
                    throw new Error('No device selected');
                }
                
                await mobileApp.api.sendCommand('system_diagnostic', {
                    full_check: true,
                    include_sensors: true,
                    include_connectivity: true
                });
                
                mobileApp.showNotification('Diagnostic syst√®me lanc√©!', 'success');
            } catch (error) {
                console.error('Failed to run diagnostic:', error);
                mobileApp.showNotification('Erreur lors du diagnostic', 'error');
            }
        }

        async function optimizeSystem() {
            console.log('‚ö° Optimizing system...');
            try {
                if (!mobileApp.currentTent) {
                    throw new Error('No device selected');
                }
                
                await mobileApp.api.sendCommand('optimize_system', {
                    clear_cache: true,
                    reduce_power: false,
                    update_intervals: true
                });
                
                mobileApp.showNotification('Syst√®me optimis√©!', 'success');
            } catch (error) {
                console.error('Failed to optimize system:', error);
                mobileApp.showNotification('Erreur lors de l\'optimisation', 'error');
            }
        }

        // üöÄ INITIALIZE MOBILE APP WITH MONGODB
        document.addEventListener('DOMContentLoaded', () => {
            mobileApp = new SmartTentMobileApp();
            
            // Global reference for debugging
            window.mobileApp = mobileApp;
            
            // Listen for API events
            mobileApp.api.addEventListener('sensorData', (data) => {
                console.log('üìä Real-time sensor data received:', data);
            });
            
            // Handle visibility change (pause updates when tab is hidden)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    mobileApp.stopAutoUpdate();
                    console.log('üì± Tab hidden - pausing updates');
                } else {
                    mobileApp.startAutoUpdate();
                    console.log('üì± Tab visible - resuming updates');
                }
            });
            
            // Handle page unload
            window.addEventListener('beforeunload', () => {
                mobileApp.stopAutoUpdate();
            });
        });

        // üì± PWA SERVICE WORKER REGISTRATION
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.error('‚ùå Service Worker registration failed:', error);
                    });
            });
        }

        // üîî PUSH NOTIFICATIONS SETUP
        if ('Notification' in window && 'serviceWorker' in navigator) {
            // Request notification permission
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    console.log('üîî Notification permission:', permission);
                });
            }
        }
    </script>
</body>
</html>
