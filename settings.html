<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4CAF50">
    <title>Smart Tent - Param√®tres</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="logo.png">
    
    <style>
        /* üé® SMART TENT THEME */
        :root {
            --primary-green: #4CAF50;
            --dark-green: #2E7D32;
            --light-green: #81C784;
            --bg-green: #F1F8E9;
            --warning-orange: #FF9800;
            --danger-red: #F44336;
            --info-blue: #2196F3;
            --text-dark: #2C3E50;
            --text-light: #7F8C8D;
            --card-shadow: 0 4px 12px rgba(46, 125, 50, 0.15);
            --border-radius: 12px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-green) 0%, #E8F5E8 100%);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* üè† HEADER */
        .header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--dark-green) 100%);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s ease;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .device-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .device-selector select {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .save-indicator {
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .save-indicator.visible {
            opacity: 1;
        }

        /* üì± MAIN CONTAINER */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* üéõÔ∏è SETTINGS SECTIONS */
        .settings-section {
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }

        .section-header {
            background: var(--bg-green);
            padding: 1.5rem;
            border-bottom: 1px solid #E0E0E0;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 0.5rem;
        }

        .section-description {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .section-content {
            padding: 1.5rem;
        }

        /* üéØ SETTING ITEMS */
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1rem 0;
            border-bottom: 1px solid var(--bg-green);
            gap: 1rem;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-info {
            flex: 1;
            min-width: 0;
        }

        .setting-label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
        }

        .setting-description {
            font-size: 0.85rem;
            color: var(--text-light);
            line-height: 1.4;
        }

        .setting-control {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* üîÑ TOGGLE SWITCHES */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-input:checked + .toggle-slider {
            background-color: var(--primary-green);
        }

        .toggle-input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* üìä RANGE SLIDERS */
        .range-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 150px;
        }

        .range-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            appearance: none;
        }

        .range-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-green);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .range-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-green);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .range-value {
            font-weight: 600;
            color: var(--primary-green);
            text-align: center;
            font-size: 0.9rem;
        }

        /* üìù INPUT FIELDS */
        .input-field {
            border: 2px solid var(--bg-green);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.9rem;
            min-width: 100px;
            transition: border-color 0.2s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-green);
        }

        .input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* üé® SELECT DROPDOWNS */
        .select-field {
            border: 2px solid var(--bg-green);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
            min-width: 120px;
        }

        .select-field:focus {
            outline: none;
            border-color: var(--primary-green);
        }

        /* üö® THRESHOLD SETTINGS */
        .threshold-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .threshold-card {
            background: var(--bg-green);
            border-radius: 8px;
            padding: 1rem;
        }

        .threshold-title {
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .threshold-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .threshold-range {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .threshold-label {
            font-size: 0.8rem;
            color: var(--text-light);
            min-width: 40px;
        }

        /* üéÆ ACTION BUTTONS */
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            background: var(--primary-green);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--dark-green);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--text-light);
        }

        .btn-secondary:hover {
            background: #6C7B7D;
        }

        .btn-danger {
            background: var(--danger-red);
        }

        .btn-danger:hover {
            background: #D32F2F;
        }

        /* üìä SYSTEM INFO */
        .system-info {
            background: var(--info-blue);
            color: white;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .info-item {
            text-align: center;
        }

        .info-value {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .info-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        /* üåô DARK MODE */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-green: #1B2E20;
                --text-dark: #E8F5E8;
                --text-light: #A5D6A7;
            }
            
            body {
                background: linear-gradient(135deg, #0D1A0F 0%, #1B2E20 100%);
            }
            
            .settings-section {
                background: #2C5530;
                color: var(--text-dark);
            }
            
            .section-header {
                background: #1B2E20;
            }
            
            .threshold-card {
                background: #1B2E20;
            }
            
            .input-field, .select-field {
                background: #1B2E20;
                color: var(--text-dark);
                border-color: #3C6041;
            }
        }

        /* üì± MOBILE RESPONSIVE */
        @media (max-width: 767px) {
            .container {
                padding: 0.5rem;
            }
            
            .setting-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .setting-control {
                width: 100%;
                justify-content: flex-end;
            }
            
            .range-container {
                min-width: 200px;
            }
            
            .threshold-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* üîÑ LOADING & ANIMATIONS */
        .loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--text-light);
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--bg-green);
            border-top: 2px solid var(--primary-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: var(--primary-green);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .success-message.visible {
            display: flex;
        }

        /* üéØ FEATURE BADGES */
        .feature-badge {
            background: var(--warning-orange);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        .feature-badge.new {
            background: var(--info-blue);
        }

        .feature-badge.pro {
            background: var(--danger-red);
        }
    </style>
</head>
<body>
    <!-- üè† HEADER -->
    <header class="header">
        <div class="header-content">
            <div class="header-title">
                <a href="sensor.html" class="back-btn">
                    ‚Üê Retour
                </a>
                <h1>‚öôÔ∏è Param√®tres</h1>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="device-selector">
                    <select id="deviceSelector">
                        <!-- Devices will be loaded dynamically -->
                    </select>
                </div>
                <div class="save-indicator" id="save-indicator">
                    üíæ Sauvegard√©
                </div>
            </div>
        </div>
    </header>

    <!-- üì± MAIN CONTENT -->
    <div class="container">
        
        <!-- üö® ALERT SETTINGS -->
        <div class="settings-section">
            <div class="section-header">
                <div class="section-title">
                    üö® Alertes & Notifications
                </div>
                <div class="section-description">
                    Configurez les seuils d'alerte pour vos capteurs et les notifications
                </div>
            </div>
            
            <div class="section-content">
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Notifications push</div>
                        <div class="setting-description">Recevoir des notifications pour les alertes critiques</div>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" class="toggle-input" id="notifications-enabled" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Heures silencieuses</div>
                        <div class="setting-description">D√©sactiver les notifications pendant certaines heures</div>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" class="toggle-input" id="quiet-hours-enabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-item" id="quiet-hours-config" style="display: none;">
                    <div class="setting-info">
                        <div class="setting-label">P√©riode silencieuse</div>
                        <div class="setting-description">D√©finir les heures de d√©but et fin</div>
                    </div>
                    <div class="setting-control">
                        <div class="input-group">
                            <input type="time" class="input-field" id="quiet-start" value="22:00">
                            <span>√†</span>
                            <input type="time" class="input-field" id="quiet-end" value="07:00">
                        </div>
                    </div>
                </div>
                
                <!-- üå°Ô∏è THRESHOLD SETTINGS -->
                <div class="threshold-grid">
                    <div class="threshold-card">
                        <div class="threshold-title">
                            üå°Ô∏è Temp√©rature
                        </div>
                        <div class="threshold-controls">
                            <div class="threshold-range">
                                <span class="threshold-label">Min:</span>
                                <input type="number" class="input-field" id="temp-min" value="5" min="-20" max="40">
                                <span>¬∞C</span>
                            </div>
                            <div class="threshold-range">
                                <span class="threshold-label">Max:</span>
                                <input type="number" class="input-field" id="temp-max" value="35" min="0" max="60">
                                <span>¬∞C</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="threshold-card">
                        <div class="threshold-title">
                            üíß Humidit√©
                        </div>
                        <div class="threshold-controls">
                            <div class="threshold-range">
                                <span class="threshold-label">Min:</span>
                                <input type="number" class="input-field" id="humidity-min" value="30" min="0" max="100">
                                <span>%</span>
                            </div>
                            <div class="threshold-range">
                                <span class="threshold-label">Max:</span>
                                <input type="number" class="input-field" id="humidity-max" value="80" min="0" max="100">
                                <span>%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="threshold-card">
                        <div class="threshold-title">
                            üí® Gaz (MQ2)
                        </div>
                        <div class="threshold-controls">
                            <div class="threshold-range">
                                <span class="threshold-label">Seuil:</span>
                                <input type="number" class="input-field" id="gas-threshold" value="300" min="50" max="1000">
                                <span>ppm</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="threshold-card">
                        <div class="threshold-title">
                            üîã Batterie
                        </div>
                        <div class="threshold-controls">
                            <div class="threshold-range">
                                <span class="threshold-label">Min:</span>
                                <input type="number" class="input-field" id="battery-min" value="20" min="5" max="50">
                                <span>%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- üëÅÔ∏è MOTION DETECTION -->
        <div class="settings-section">
            <div class="section-header">
                <div class="section-title">
                    üëÅÔ∏è D√©tection de Mouvement
                    <span class="feature-badge">SMART</span>
                </div>
                <div class="section-description">
                    Configuration intelligente des alertes de mouvement jour/nuit
                </div>
            </div>
            
            <div class="section-content">
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Mouvement int√©rieur (jour)</div>
                        <div class="setting-description">Alertes pour mouvement √† l'int√©rieur pendant la journ√©e seulement</div>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" class="toggle-input" id="motion-interior-day" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Mouvement ext√©rieur (nuit)</div>
                        <div class="setting-description">Alertes pour mouvement √† l'ext√©rieur pendant la nuit seulement</div>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" class="toggle-input" id="motion-exterior-night" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Sensibilit√©</div>
                        <div class="setting-description">R√©glage de la sensibilit√© des capteurs de mouvement</div>
                    </div>
                    <div class="setting-control">
                        <div class="range-container">
                            <input type="range" class="range-slider" id="motion-sensitivity" min="1" max="10" value="5">
                            <div class="range-value" id="motion-sensitivity-value">5</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- üì° SYST√àME & CONNECTIVIT√â -->
        <div class="settings-section">
            <div class="section-header">
                <div class="section-title">
                    üì° Syst√®me & Connectivit√©
                </div>
                <div class="section-description">
                    Param√®tres de mise √† jour, 4G et optimisations
                </div>
            </div>
            
            <div class="section-content">
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Mise √† jour automatique</div>
                        <div class="setting-description">R√©cup√©rer automatiquement les nouvelles donn√©es</div>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" class="toggle-input" id="auto-update" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Fr√©quence de rafra√Æchissement</div>
                        <div class="setting-description">Intervalle entre les mises √† jour des donn√©es</div>
                    </div>
                    <div class="setting-control">
                        <div class="range-container">
                            <input type="range" class="range-slider" id="refresh-interval" min="1" max="30" value="2">
                            <div class="range-value" id="refresh-interval-value">2 secondes</div>
                        </div>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Mode √©conomie 4G</div>
                        <div class="setting-description">R√©duire l'utilisation des donn√©es mobiles</div>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" class="toggle-input" id="data-saver">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Stockage hors ligne</div>
                        <div class="setting-description">Dur√©e de conservation des donn√©es locales</div>
                    </div>
                    <div class="setting-control">
                        <select class="select-field" id="offline-storage">
                            <option value="1">1 jour</option>
                            <option value="7" selected>7 jours</option>
                            <option value="30">30 jours</option>
                            <option value="90">90 jours</option>
                        </select>
                    </div>
                </div>
                
                <!-- SYSTEM INFO -->
                <div class="system-info">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">üìä Informations Syst√®me</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-value" id="app-version">v1.0.0</div>
                            <div class="info-label">Version</div>
                        </div>
                        <div class="info-item">
                            <div class="info-value" id="data-usage">--</div>
                            <div class="info-label">Donn√©es utilis√©es</div>
                        </div>
                        <div class="info-item">
                            <div class="info-value" id="cache-size">--</div>
                            <div class="info-label">Cache</div>
                        </div>
                        <div class="info-item">
                            <div class="info-value" id="last-sync">--</div>
                            <div class="info-label">Derni√®re sync</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- üé® AFFICHAGE -->
        <div class="settings-section">
            <div class="section-header">
                <div class="section-title">
                    üé® Affichage & Interface
                </div>
                <div class="section-description">
                    Personnalisation de l'interface utilisateur
                </div>
            </div>
            
            <div class="section-content">
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Mode sombre</div>
                        <div class="setting-description">Interface sombre pour √©conomiser la batterie</div>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" class="toggle-input" id="dark-mode">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Afficher la cam√©ra</div>
                        <div class="setting-description">Montrer le flux de la cam√©ra sur le tableau de bord</div>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" class="toggle-input" id="show-camera" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Animation des graphiques</div>
                        <div class="setting-description">Animations pour les transitions des graphiques</div>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" class="toggle-input" id="chart-animations" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- üîß MAINTENANCE -->
        <div class="settings-section">
            <div class="section-header">
                <div class="section-title">
                    üîß Maintenance & Support
                </div>
                <div class="section-description">
                    Outils de diagnostic et support technique
                </div>
            </div>
            
            <div class="section-content">
                <div class="action-buttons">
                    <button class="btn" onclick="runDiagnostic()">
                        üîç Diagnostic syst√®me
                    </button>
                    <button class="btn btn-secondary" onclick="syncSettings()">
                        üîÑ Synchroniser
                    </button>
                    <button class="btn btn-secondary" onclick="clearCache()">
                        üóëÔ∏è Vider le cache
                    </button>
                    <button class="btn btn-danger" onclick="resetSettings()">
                        ‚ö†Ô∏è R√©initialiser
                    </button>
                </div>
                
                <div class="success-message" id="success-message">
                    ‚úÖ <span id="success-text">Op√©ration r√©ussie!</span>
                </div>
            </div>
        </div>

    </div>

    <!-- Include API -->
    <script src="api.js"></script>
    
    <script>
        // ‚öôÔ∏è SMART TENT SETTINGS MANAGER - MongoDB Version
        class SmartTentSettings {
            constructor() {
                this.api = window.smartTentAPI;
                this.settings = {};
                this.currentDevice = null;
                this.saveTimeout = null;
                
                this.init();
            }

            async init() {
                console.log('‚öôÔ∏è Initializing Smart Tent Settings...');
                
                // Load devices first
                await this.loadDevices();
                
                // Load current settings
                await this.loadSettings();
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Load system info
                this.loadSystemInfo();
                
                console.log('‚úÖ Settings initialized');
            }

            async loadDevices() {
                try {
                    console.log('üîç Loading devices from API...');
                    const response = await fetch(`${this.api.config.baseUrl}/api/devices`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const devices = await response.json();
                    console.log('üì± Devices loaded:', devices);
                    
                    const selector = document.getElementById('deviceSelector');
                    selector.innerHTML = devices.map(device => 
                        `<option value="${device.device_id}">üèïÔ∏è ${device.name}</option>`
                    ).join('');
                    
                    // Select first device
                    if (devices.length > 0) {
                        this.currentDevice = devices[0].device_id;
                        selector.value = this.currentDevice;
                    }
                    
                } catch (error) {
                    console.error('‚ùå Failed to load devices:', error);
                    // Fallback to localStorage devices
                    const savedDevices = localStorage.getItem('smartTentDevices');
                    if (savedDevices) {
                        const devices = JSON.parse(savedDevices);
                        const selector = document.getElementById('deviceSelector');
                        selector.innerHTML = devices.map(device => 
                            `<option value="${device.id}">üèïÔ∏è ${device.name}</option>`
                        ).join('');
                        if (devices.length > 0) {
                            this.currentDevice = devices[0].id;
                        }
                    }
                }
            }

            async loadSettings() {
                try {
                    if (!this.currentDevice) {
                        console.warn('No device selected for settings');
                        this.settings = this.getDefaultSettings();
                        this.applySettingsToUI();
                        return;
                    }
                    
                    console.log(`üîß Loading settings for device: ${this.currentDevice}`);
                    
                    // Try to load from API
                    const response = await fetch(`${this.api.config.baseUrl}/api/settings/${this.currentDevice}`);
                    
                    if (response.ok) {
                        const apiSettings = await response.json();
                        console.log('üì° Settings loaded from API:', apiSettings);
                        this.settings = apiSettings.settings || this.getDefaultSettings();
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Failed to load settings from API:', error);
                    
                    // Fallback to localStorage
                    const savedSettings = localStorage.getItem(`smart-tent-settings-${this.currentDevice}`);
                    this.settings = savedSettings ? JSON.parse(savedSettings) : this.getDefaultSettings();
                    console.log('üíæ Using local settings');
                }
                
                // Apply settings to UI
                this.applySettingsToUI();
            }

            getDefaultSettings() {
                return {
                    alerts: {
                        notificationsEnabled: true,
                        quietHoursEnabled: false,
                        quietStart: '22:00',
                        quietEnd: '07:00',
                        thresholds: {
                            tempMin: 5,
                            tempMax: 35,
                            humidityMin: 30,
                            humidityMax: 80,
                            gasThreshold: 300,
                            batteryMin: 20
                        }
                    },
                    motion: {
                        interiorDay: true,
                        exteriorNight: true,
                        sensitivity: 5
                    },
                    system: {
                        autoUpdate: true,
                        refreshInterval: 2,
                        dataSaver: false,
                        offlineStorage: 7
                    },
                    display: {
                        darkMode: false,
                        showCamera: true,
                        chartAnimations: true
                    }
                };
            }

            applySettingsToUI() {
                // Alerts
                document.getElementById('notifications-enabled').checked = this.settings.alerts.notificationsEnabled;
                document.getElementById('quiet-hours-enabled').checked = this.settings.alerts.quietHoursEnabled;
                document.getElementById('quiet-start').value = this.settings.alerts.quietStart;
                document.getElementById('quiet-end').value = this.settings.alerts.quietEnd;
                
                // Thresholds
                document.getElementById('temp-min').value = this.settings.alerts.thresholds.tempMin;
                document.getElementById('temp-max').value = this.settings.alerts.thresholds.tempMax;
                document.getElementById('humidity-min').value = this.settings.alerts.thresholds.humidityMin;
                document.getElementById('humidity-max').value = this.settings.alerts.thresholds.humidityMax;
                document.getElementById('gas-threshold').value = this.settings.alerts.thresholds.gasThreshold;
                document.getElementById('battery-min').value = this.settings.alerts.thresholds.batteryMin;
                
                // Motion
                document.getElementById('motion-interior-day').checked = this.settings.motion.interiorDay;
                document.getElementById('motion-exterior-night').checked = this.settings.motion.exteriorNight;
                document.getElementById('motion-sensitivity').value = this.settings.motion.sensitivity;
                
                // System
                document.getElementById('auto-update').checked = this.settings.system.autoUpdate;
                document.getElementById('refresh-interval').value = this.settings.system.refreshInterval;
                document.getElementById('data-saver').checked = this.settings.system.dataSaver;
                document.getElementById('offline-storage').value = this.settings.system.offlineStorage;
                
                // Display
                document.getElementById('dark-mode').checked = this.settings.display.darkMode;
                document.getElementById('show-camera').checked = this.settings.display.showCamera;
                document.getElementById('chart-animations').checked = this.settings.display.chartAnimations;
                
                // Update range displays
                this.updateRangeDisplays();
                
                // Show/hide quiet hours config
                this.toggleQuietHoursConfig();
                
                // Apply dark mode
                this.applyDarkMode();
            }

            setupEventListeners() {
                // Device selector
                document.getElementById('deviceSelector').addEventListener('change', async (e) => {
                    this.currentDevice = e.target.value;
                    await this.loadSettings();
                });
                
                // All input elements
                const inputs = document.querySelectorAll('input, select');
                inputs.forEach(input => {
                    input.addEventListener('change', () => this.handleSettingChange());
                });
                
                // Range sliders
                document.getElementById('motion-sensitivity').addEventListener('input', (e) => {
                    document.getElementById('motion-sensitivity-value').textContent = e.target.value;
                });
                
                document.getElementById('refresh-interval').addEventListener('input', (e) => {
                    const value = e.target.value;
                    const text = value == 1 ? '1 seconde' : `${value} secondes`;
                    document.getElementById('refresh-interval-value').textContent = text;
                });
                
                // Quiet hours toggle
                document.getElementById('quiet-hours-enabled').addEventListener('change', () => {
                    this.toggleQuietHoursConfig();
                });
                
                // Dark mode toggle
                document.getElementById('dark-mode').addEventListener('change', () => {
                    this.applyDarkMode();
                });
            }

            updateRangeDisplays() {
                document.getElementById('motion-sensitivity-value').textContent = this.settings.motion.sensitivity;
                
                const refreshValue = this.settings.system.refreshInterval;
                const refreshText = refreshValue == 1 ? '1 seconde' : `${refreshValue} secondes`;
                document.getElementById('refresh-interval-value').textContent = refreshText;
            }

            toggleQuietHoursConfig() {
                const enabled = document.getElementById('quiet-hours-enabled').checked;
                const config = document.getElementById('quiet-hours-config');
                config.style.display = enabled ? 'flex' : 'none';
            }

            applyDarkMode() {
                const darkMode = document.getElementById('dark-mode').checked;
                if (darkMode) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }
            }

            handleSettingChange() {
                // Collect all settings from UI
                this.settings = {
                    alerts: {
                        notificationsEnabled: document.getElementById('notifications-enabled').checked,
                        quietHoursEnabled: document.getElementById('quiet-hours-enabled').checked,
                        quietStart: document.getElementById('quiet-start').value,
                        quietEnd: document.getElementById('quiet-end').value,
                        thresholds: {
                            tempMin: parseInt(document.getElementById('temp-min').value),
                            tempMax: parseInt(document.getElementById('temp-max').value),
                            humidityMin: parseInt(document.getElementById('humidity-min').value),
                            humidityMax: parseInt(document.getElementById('humidity-max').value),
                            gasThreshold: parseInt(document.getElementById('gas-threshold').value),
                            batteryMin: parseInt(document.getElementById('battery-min').value)
                        }
                    },
                    motion: {
                        interiorDay: document.getElementById('motion-interior-day').checked,
                        exteriorNight: document.getElementById('motion-exterior-night').checked,
                        sensitivity: parseInt(document.getElementById('motion-sensitivity').value)
                    },
                    system: {
                        autoUpdate: document.getElementById('auto-update').checked,
                        refreshInterval: parseInt(document.getElementById('refresh-interval').value),
                        dataSaver: document.getElementById('data-saver').checked,
                        offlineStorage: parseInt(document.getElementById('offline-storage').value)
                    },
                    display: {
                        darkMode: document.getElementById('dark-mode').checked,
                        showCamera: document.getElementById('show-camera').checked,
                        chartAnimations: document.getElementById('chart-animations').checked
                    }
                };
                
                // Debounced save
                this.debouncedSave();
            }

            debouncedSave() {
                clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(() => {
                    this.saveSettings();
                }, 1000);
            }

            async saveSettings() {
                if (!this.currentDevice) {
                    console.warn('No device selected for saving settings');
                    return;
                }
                
                try {
                    console.log(`üíæ Saving settings for device: ${this.currentDevice}`);
                    
                    // Save to API
                    const response = await fetch(`${this.api.config.baseUrl}/api/settings/${this.currentDevice}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            device_id: this.currentDevice,
                            settings: this.settings,
                            timestamp: new Date().toISOString()
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('‚úÖ Settings saved to API:', result);
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Failed to save settings to API:', error);
                }
                
                // Always save to localStorage as backup
                localStorage.setItem(`smart-tent-settings-${this.currentDevice}`, JSON.stringify(this.settings));
                
                // Show save indicator
                this.showSaveIndicator();
                
                // Apply system-level changes
                this.applySystemSettings();
                
                console.log('‚úÖ Settings saved successfully');
            }

            showSaveIndicator() {
                const indicator = document.getElementById('save-indicator');
                indicator.classList.add('visible');
                setTimeout(() => {
                    indicator.classList.remove('visible');
                }, 2000);
            }

            applySystemSettings() {
                // Apply refresh interval to API
                if (this.api && this.api.config) {
                    this.api.config.updateInterval = this.settings.system.refreshInterval * 1000;
                    
                    // Restart auto-update if enabled
                    if (this.settings.system.autoUpdate) {
                        this.api.stopAutoUpdate();
                        this.api.startAutoUpdate();
                    } else {
                        this.api.stopAutoUpdate();
                    }
                }
                
                // Apply data saver mode
                if (this.settings.system.dataSaver) {
                    console.log('üì± Data saver mode enabled');
                }
            }

            loadSystemInfo() {
                // App version
                document.getElementById('app-version').textContent = 'v1.0.0';
                
                // Calculate cache size
                let cacheSize = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        cacheSize += localStorage[key].length;
                    }
                }
                document.getElementById('cache-size').textContent = this.formatBytes(cacheSize);
                
                // Last sync (placeholder)
                document.getElementById('last-sync').textContent = 'Maintenant';
                
                // Data usage (placeholder)
                document.getElementById('data-usage').textContent = '2.3 MB';
            }

            formatBytes(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            }

            showSuccess(message) {
                const successDiv = document.getElementById('success-message');
                document.getElementById('success-text').textContent = message;
                successDiv.classList.add('visible');
                setTimeout(() => {
                    successDiv.classList.remove('visible');
                }, 3000);
            }

            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                notification.style.cssText = `
                    position: fixed; bottom: 20px; right: 20px; z-index: 1000;
                    background: ${type === 'success' ? '#4CAF50' : '#F44336'};
                    color: white; padding: 12px 20px; border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }

        // üéÆ GLOBAL FUNCTIONS
        let settingsManager;

        async function runDiagnostic() {
            console.log('üîç Running system diagnostic...');
            
            try {
                // Test API connection
                const response = await fetch(`${settingsManager.api.config.baseUrl}/api/devices`);
                const connectionStatus = response.ok ? 'OK' : 'FAILED';
                
                settingsManager.showSuccess(`Diagnostic termin√© - API: ${connectionStatus}, Cache: OK, Stockage: OK`);
                
            } catch (error) {
                settingsManager.showSuccess('Diagnostic termin√© - Probl√®me de connexion API d√©tect√©');
            }
        }

        async function syncSettings() {
            console.log('üîÑ Syncing settings with server...');
            
            if (!settingsManager.currentDevice) {
                alert('Aucun appareil s√©lectionn√©');
                return;
            }
            
            try {
                // Force reload settings from server
                await settingsManager.loadSettings();
                settingsManager.showSuccess('Param√®tres synchronis√©s avec succ√®s');
                
            } catch (error) {
                console.error('Sync failed:', error);
                settingsManager.showNotification('Erreur lors de la synchronisation', 'error');
            }
        }

        async function clearCache() {
            if (confirm('√ätes-vous s√ªr de vouloir vider le cache? Cela supprimera toutes les donn√©es hors ligne.')) {
                try {
                    // Clear localStorage
                    const keysToKeep = ['smart-tent-settings'];
                    const allKeys = Object.keys(localStorage);
                    
                    allKeys.forEach(key => {
                        if (!keysToKeep.some(keepKey => key.includes(keepKey))) {
                            localStorage.removeItem(key);
                        }
                    });
                    
                    // Clear caches API
                    if ('caches' in window) {
                        const cacheNames = await caches.keys();
                        await Promise.all(
                            cacheNames.map(cacheName => caches.delete(cacheName))
                        );
                    }
                    
                    // Reload system info
                    settingsManager.loadSystemInfo();
                    
                    settingsManager.showSuccess('Cache vid√© avec succ√®s');
                } catch (error) {
                    settingsManager.showNotification('Erreur lors du vidage du cache', 'error');
                }
            }
        }

        function resetSettings() {
            if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser tous les param√®tres aux valeurs par d√©faut?')) {
                settingsManager.settings = settingsManager.getDefaultSettings();
                settingsManager.applySettingsToUI();
                settingsManager.saveSettings();
                settingsManager.showSuccess('Param√®tres r√©initialis√©s aux valeurs par d√©faut');
            }
        }

        // üöÄ INITIALIZE SETTINGS
        document.addEventListener('DOMContentLoaded', () => {
            settingsManager = new SmartTentSettings();
        });
    </script>
</body>
</html>
